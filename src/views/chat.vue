<template>
    <div class="background-view">
      <div class="storybook-view">
        <!-- ÊïÖ‰∫ãÂéÜÂè≤‰æßËæπÊ†è -->
        <div class="history-sidebar" :class="{ collapsed: sidebarCollapsed }">
          <div class="sidebar-header">
            <h3 v-show="!sidebarCollapsed">ÊïÖ‰∫ãÂéÜÂè≤</h3>
            <div class="toggle-btn-container">
              <button class="toggle-btn" @click="toggleSidebar" :title="sidebarCollapsed ? 'Â±ïÂºÄ‰æßËæπÊ†è' : 'Êî∂Ëµ∑‰æßËæπÊ†è'">
                <i :class="sidebarCollapsed ? 'el-icon-arrow-right' : 'el-icon-arrow-left'"></i>
              </button>
            </div>
          </div>
          
          <div v-if="historyLoading" class="sidebar-loading">
            <div class="loading-spinner"></div>
            <span v-show="!sidebarCollapsed">Âä†ËΩΩ‰∏≠...</span>
          </div>
          
          <div v-else-if="historyList.length === 0" class="empty-history">
            <i class="el-icon-document"></i>
            <p v-show="!sidebarCollapsed">ËøòÊ≤°ÊúâÊïÖ‰∫ãÂéÜÂè≤ËÆ∞ÂΩï</p>
          </div>
          
          <div v-else class="history-list">
            <div 
              v-for="(item, index) in historyList" 
              :key="index" 
              class="history-item"
              @click="viewHistoryDetail(item.id)"
              :title="item.storyTheme"
            >
              <div class="history-item-header" v-show="!sidebarCollapsed">
                <span class="history-title">{{ item.storyTheme }}</span>
                <span class="history-type" :class="item.storyType">{{ item.storyType }}</span>
              </div>
              <div v-show="sidebarCollapsed" class="history-icon">
                <i class="el-icon-notebook-2"></i>
              </div>
              <div v-show="!sidebarCollapsed" class="history-item-date">{{ formatDate(item.createTime) }}</div>
              <div v-show="!sidebarCollapsed" class="history-item-duration">Êó∂Èïø: {{ formatDuration(item.duration) }}</div>
            </div>
          </div>
          
          <div class="sidebar-footer">
            <el-button v-show="!sidebarCollapsed" size="small" type="info" @click="loadHistoryList">Âà∑Êñ∞</el-button>
            <i v-show="sidebarCollapsed" class="el-icon-refresh refresh-icon" @click="loadHistoryList" title="Âà∑Êñ∞ÂéÜÂè≤ËÆ∞ÂΩï"></i>
          </div>
          
          <!-- ÊÇ¨ÊµÆÊî∂Áº©ÊåâÈíÆ (Âú®ÂÆΩÂ±èÊ®°Âºè‰∏ãÊòæÁ§∫) -->
          <div class="floating-toggle" v-if="!sidebarCollapsed && !isMobileView" @click="toggleSidebar" title="Êî∂Ëµ∑‰æßËæπÊ†è">
            <i class="el-icon-d-arrow-left"></i>
          </div>
        </div>
        
        <div class="storybook-panel" :class="{ 'expanded': sidebarCollapsed }">
          <div class="message-panel">
            <div class="header">
              <div class="header-left">
                <button v-if="sidebarCollapsed" class="expand-sidebar-btn" @click="toggleSidebar" title="Â±ïÂºÄÂéÜÂè≤‰æßËæπÊ†è">
                  <i class="el-icon-notebook-2"></i>
                </button>
                <h2>‰∫íÂä®ÊïÖ‰∫ã‰π¶</h2>
              </div>
              <div class="header-actions">
                <button class="mobile-sidebar-toggle" @click="toggleSidebar">
                  <i class="el-icon-notebook-2"></i> ÂéÜÂè≤
                </button>
                <el-button type="info" size="small" icon="el-icon-document" @click="goToHistory">ÂéÜÂè≤ËÆ∞ÂΩï</el-button>
                <span class="status-indicator" :class="{ online: isConnected }">
                  {{ isConnected ? 'ËøûÊé•ÊàêÂäü' : 'ËøûÊé•‰∏≠...' }}
                </span>
              </div>
            </div>
            
            <!-- Êñ∞ÊïÖ‰∫ãÈÄâÊã©Âå∫Âüü -->
            <div v-if="!storyStarted" class="story-setup">
              <div class="story-setup-container">
                <h3>ÂºÄÂßã‰∏Ä‰∏™Êñ∞ÊïÖ‰∫ãÂêßÔºÅ</h3>
                
                <div class="setup-form">
                  <div class="form-item">
                    <label>Â∞èÊúãÂèãÁöÑÂêçÂ≠ó</label>
                    <div class="child-name-selector">
                      <el-select 
                        v-model="selectedChild" 
                        filterable 
                        placeholder="ÈÄâÊã©ÊàñÂàõÂª∫Â∞èÊúãÂèã" 
                        @change="handleChildSelect"
                        style="width: 100%;"
                      >
                        <el-option-group label="Â∑≤ÊúâÂ∞èÊúãÂèã">
                          <el-option 
                            v-for="child in childrenList" 
                            :key="child.id" 
                            :label="child.name + ' (' + child.age + 'Â≤Å)'" 
                            :value="child.id">
                          </el-option>
                        </el-option-group>
                        <el-option value="create-new" label="+ ÂàõÂª∫Êñ∞Â∞èÊúãÂèã"></el-option>
                      </el-select>
                      
                      <div v-if="showCreateChild" class="create-child-form">
                        <el-input v-model="childName" placeholder="ËØ∑ËæìÂÖ•Â∞èÊúãÂèãÁöÑÂêçÂ≠ó"></el-input>
                        <el-select v-model="childAge" placeholder="ÈÄâÊã©Âπ¥ÈæÑ">
                          <el-option v-for="age in [6,7,8,9]" :key="age" :label="`${age}Â≤Å`" :value="age"></el-option>
                        </el-select>
                        <el-select v-model="childGender" placeholder="ÈÄâÊã©ÊÄßÂà´">
                          <el-option label="Áî∑Â≠©" value="Áî∑"></el-option>
                          <el-option label="Â•≥Â≠©" value="Â•≥"></el-option>
                        </el-select>
                        <div class="child-form-actions">
                          <el-button type="primary" size="small" @click="createNewChild" :loading="creatingChild">‰øùÂ≠ò</el-button>
                          <el-button size="small" @click="cancelCreateChild">ÂèñÊ∂à</el-button>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div v-if="!showCreateChild" class="form-item">
                    <label>Â∞èÊúãÂèãÁöÑÂπ¥ÈæÑ</label>
                    <el-select v-model="childAge" placeholder="ÈÄâÊã©Âπ¥ÈæÑ" :disabled="selectedChild && selectedChild !== 'create-new'">
                      <el-option v-for="age in [6,7,8,9]" :key="age" :label="`${age}Â≤Å`" :value="age"></el-option>
                    </el-select>
                  </div>
                  
                  <div class="form-item">
                    <label>ÊïÖ‰∫ãÁ±ªÂûã</label>
                    <el-radio-group v-model="storyType">
                      <el-radio label="ÁîüÊ¥ªÊïôËÇ≤">ÁîüÊ¥ªÊïôËÇ≤</el-radio>
                      <el-radio label="Â≠¶‰π†ÊàêÈïø">Â≠¶‰π†ÊàêÈïø</el-radio>
                    </el-radio-group>
                  </div>
                </div>
                
                <div class="story-themes">
                  <h4>ÊïÖ‰∫ã‰∏ªÈ¢ò</h4>
                  <div class="theme-cards">
                    <div 
                      v-for="(theme, index) in storyThemes[storyType]" 
                      :key="index" 
                      class="theme-card"
                      @click="selectTheme(theme)"
                      :class="{ selected: selectedTheme === theme }"
                    >
                      <div class="theme-icon">üîÆ</div>
                      <div class="theme-name">{{ theme }}</div>
                    </div>
                  </div>
                </div>
                
                <el-button type="primary" @click="startStory" :disabled="!canStartStory">
                  ÂºÄÂßãÊïÖ‰∫ã
                </el-button>
              </div>
            </div>
            
            <!-- ÊïÖ‰∫ãÂÜÖÂÆπÂå∫Âüü -->
            <div v-else class="story-content">
              <!-- ÊïÖ‰∫ãÊ∂àÊÅØÂàóË°® -->
               <div class="message-list" ref="messageContainer">
                <div
                  v-for="(message, index) in messages"
                  :key="index"
                  :class="['message-row', message.type]"
                >
                  <div v-if="message.type === 'ai'" class="message-avatar">
                    <img :src="aiAvatar" alt="ÊïÖ‰∫ãÁ≤æÁÅµ" class="avatar" @error="handleAvatarError($event, 'ai')" />
                  </div>
                  <div :class="['message', message.type === 'user' ? 'user-message' : 'ai-message']">
                    <div v-html="formatContentWithPinyin(message.content)"></div>
                  </div>
                   <div class="message-time">{{ formatMessageTime(message.createTime) }}</div>
                  <!-- Ê∑ªÂä†Êí≠ÊîæËØ≠Èü≥ÊåâÈíÆ -->
                    <el-button
                    v-if="message.type === 'ai'"
                    type="text"
                    @click="toggleSpeech(message)"
                  >
                    <i class="el-icon-volume-up"></i> {{ getButtonText(message) }}
                  </el-button>
                
                  <div v-if="message.type === 'user'" class="message-avatar">
                    <img :src="userAvatar || generateUserAvatar" alt="Â∞èÊúãÂèãÂ§¥ÂÉè" class="avatar" @error="handleAvatarError($event, 'user')" />
                  </div>
                </div>
              </div>
  
  
              <!-- ‰∫íÂä®ËæìÂÖ•Âå∫Âüü -->
              <div class="message-input">
                <el-input
                  v-model="userInput"
                  type="textarea"
                  :rows="2"
                  :placeholder="inputPlaceholder"
                  @keyup.enter.native="sendMessage"
                />
                <div class="control-buttons">
                  <el-button type="warning" @click="restartStory">
                    ÈáçÊñ∞ÂºÄÂßã
                  </el-button>
                  <el-button type="primary" @click="sendMessage" :loading="loading">
                    <i class="el-icon-s-promotion"></i> ÂèëÈÄÅ
                  </el-button>
                  <el-button type="success" @click="toggleVoiceInput">
                    <i :class="isListening ? 'el-icon-microphone' : 'el-icon-turn-off-microphone'"></i> 
                    {{ isListening ? 'Ê≠£Âú®Âê¨...' : 'ËØ≠Èü≥ËæìÂÖ•' }}
                  </el-button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>
  
  <script setup>
  import { ref, reactive, computed, onMounted, onBeforeUnmount, nextTick, watch } from 'vue';
  import { useRouter } from 'vue-router';
  import { ElMessage, ElMessageBox } from 'element-plus';
  import userAvatarImg from '@/assets/user.jpg';
  import aiAvatarImg from '@/assets/ai.jpg';
  import axios from '../utils/axios';

  // Ë∑ØÁî±
  const router = useRouter();

  // Áî®‰∫éÊéßÂà∂ÊªöÂä®Êõ¥Êñ∞ÁöÑËÆ°Êó∂Âô®
  let scrollUpdateTimeout = null;

  // ‰æßËæπÊ†èÁä∂ÊÄÅ
  const sidebarCollapsed = ref(localStorage.getItem('sidebarCollapsed') === 'true');
  const historyList = ref([]);
  const historyLoading = ref(false);
  const isMobileView = ref(window.innerWidth <= 768);

  // Ê∂àÊÅØÊï∞ÊçÆ
  const messages = ref([]);
  const userInput = ref('');
  const loading = ref(false);
  const socket = ref(null);
  const isConnected = ref(false);
  const reconnectAttempts = ref(0);
  const maxReconnectAttempts = 5;
  const reconnectInterval = 3000;

  // ÊïÖ‰∫ãËÆæÁΩÆ
  const storyStarted = ref(false);
  const childName = ref('');
  const childAge = ref(5);
  const childGender = ref('');
  const storyType = ref('Â≠¶‰π†ÊàêÈïø');
  const childrenList = ref([]);
  const selectedChild = ref(null);
  const showCreateChild = ref(false);
  const creatingChild = ref(false);
  const storyThemes = reactive({
    'ÁîüÊ¥ªÊïôËÇ≤': [
      'Âà∑ÁâôÊ¥óËÑ∏', 'ÂÅ•Â∫∑È•ÆÈ£ü', 'Áù°ÂâçÊïÖ‰∫ã', 
      'ÂÆâÂÖ®Áü•ËØÜ', 'ÂÖ¨ÂÖ±Á§º‰ª™', 'Êï¥ÁêÜÁé©ÂÖ∑'
    ],
    'Â≠¶‰π†ÊàêÈïø': [
      'ÂèãË∞äÂàÜ‰∫´', 'ÊÉÖÁª™ÁÆ°ÁêÜ', 'Âä®Áâ©‰∏ñÁïå', 
      'Êé¢Á¥¢ÂÆáÂÆô', 'Â≠óÊØçÊï∞Â≠ó', 'Èü≥‰πêËâ∫ÊúØ'
    ]
  });
  const selectedTheme = ref('');
  const startTime = ref(0);
  const childId = ref(null);

  // Â§¥ÂÉè
  const userAvatar = ref(userAvatarImg);
  const aiAvatar = ref(aiAvatarImg);

  // ËØ≠Èü≥ËØÜÂà´
  const recognition = ref(null);
  const isListening = ref(false);

  // ‰ªé localStorage Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
  const userId = ref(localStorage.getItem('userId') || 'guest-user');

  // DOMÂºïÁî®
  const messageContainer = ref(null);

  // ËÆ°ÁÆóÂ±ûÊÄß
  const inputPlaceholder = computed(() => {
    return isListening.value ? 'Ê≠£Âú®ËÅÜÂê¨‰Ω†ÁöÑÂ£∞Èü≥...' : 'Â∞èÊúãÂèãÔºå‰Ω†ÊÉ≥ÊÄé‰πàÂÅöÂë¢Ôºü';
  });

  const canStartStory = computed(() => {
    if (showCreateChild.value) {
      return childName.value.trim() && childAge.value && storyType.value && selectedTheme.value;
    }
    return ((selectedChild.value && selectedChild.value !== 'create-new') || childName.value.trim()) && 
      childAge.value && storyType.value && selectedTheme.value;
  });

  const generateUserAvatar = computed(() => {
    return `https://api.dicebear.com/7.x/adventurer/svg?seed=${childName.value || 'child'}`;
  });
  // ËØ≠Èü≥ÂêàÊàêÂÆû‰æã
const synth = window.speechSynthesis;
// Áî®‰∫éÂ≠òÂÇ®ÊØè‰∏™Ê∂àÊÅØÁöÑËØ≠Èü≥Êí≠ÊîæÁä∂ÊÄÅ
const speechStates = ref({});
// ÂàáÊç¢ËØ≠Èü≥Êí≠ÊîæÁä∂ÊÄÅ
const toggleSpeech = (message) => {
  const { id } = message;
  const currentState = speechStates.value[id];

  if (!currentState) {
    // Á¨¨‰∏ÄÊ¨°ÁÇπÂáªÔºåÂºÄÂßãÊí≠Êîæ
    playSpeech(message.content);
    speechStates.value[id] = { playing: true, paused: false };
  } else if (currentState.playing &&!currentState.paused) {
    // Ê≠£Âú®Êí≠ÊîæÔºåÁÇπÂáªÊöÇÂÅú
    synth.pause();
    speechStates.value[id].paused = true;
  } else if (currentState.playing && currentState.paused) {
    // Â∑≤ÊöÇÂÅúÔºåÁÇπÂáªÁªßÁª≠Êí≠Êîæ
    synth.resume();
    speechStates.value[id].paused = false;
  }
};
// Êí≠ÊîæËØ≠Èü≥ÊñπÊ≥ï
const playSpeech = (text) => {
  if (synth.speaking) {
    synth.cancel();
  }
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'zh-CN';
  synth.speak(utterance);
};
// Ëé∑ÂèñÊåâÈíÆÊñáÂ≠ó
const getButtonText = (message) => {
  const { id } = message;
  const currentState = speechStates.value[id];

  if (!currentState) {
    return 'Êí≠ÊîæËØ≠Èü≥';
  } else if (currentState.playing &&!currentState.paused) {
    return 'ÊöÇÂÅú';
  } else if (currentState.playing && currentState.paused) {
    return 'ÁªßÁª≠Êí≠Êîæ';
  }
};
// Ê†ºÂºèÂåñÊ∂àÊÅØÊó∂Èó¥
const formatMessageTime = (timestamp) => {
  if (!timestamp) return '';
  const date = new Date(timestamp);
  return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
};
  // Ëé∑ÂèñÊú¨Âú∞Â≠òÂÇ®ÁöÑËÆæÁΩÆ
const storedSettings = JSON.parse(localStorage.getItem('settings')) || {};

onMounted(() => {
  // Â∫îÁî®‰∏ªÈ¢òÊ®°Âºè
  if (storedSettings.themeMode === 'dark') {
    document.body.classList.add('dark-mode');
  } else {
    document.body.classList.remove('dark-mode');
  }

  // Â∫îÁî®‰æßËæπÊ†èÂõ∫ÂÆöËÆæÁΩÆ
  // ËøôÈáåÈúÄË¶ÅÊ†πÊçÆÂÆûÈôÖÁöÑ‰æßËæπÊ†èÁªÑ‰ª∂ÈÄªËæëËøõË°åË∞ÉÊï¥
  sidebarCollapsed.value = !storedSettings.sidebarFixed;

  // Â∫îÁî®Ê∂àÊÅØÊ∞îÊ≥°ÂΩ¢Áä∂ËÆæÁΩÆ
  // ËøôÈáåÈúÄË¶ÅÊ†πÊçÆÂÆûÈôÖÁöÑÊ∂àÊÅØÊ∞îÊ≥°Ê†∑ÂºèËøõË°åË∞ÉÊï¥
  if (storedSettings.messageBubbleShape === 'square') {
    // Ê∑ªÂä†Êàñ‰øÆÊîπÊ∂àÊÅØÊ∞îÊ≥°Ê†∑Âºè‰∏∫Áõ¥Ëßí
    
  } else {
    // Ê∑ªÂä†Êàñ‰øÆÊîπÊ∂àÊÅØÊ∞îÊ≥°Ê†∑Âºè‰∏∫ÂúÜËßí
  }

  // Â∫îÁî®Â≠ó‰ΩìÂ§ßÂ∞èËÆæÁΩÆ
  document.documentElement.style.fontSize = storedSettings.fontSize === 'small' ? '14px' : storedSettings.fontSize === 'medium' ? '18px' : '22px';

});
  // ÁîüÂëΩÂë®ÊúüÈí©Â≠ê
  onMounted(() => {
    // ÂàùÂßãÂåñËØ≠Èü≥ËØÜÂà´
    initSpeechRecognition();

    // ‰ªélocalStorageËé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
    const userStr = localStorage.getItem('user');
    if (userStr) {
      try {
        const user = JSON.parse(userStr);
        userId.value = user.id;
        
        // Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩïÂàóË°®
        loadHistoryList();
        
        // Âä†ËΩΩËØ•Áî®Êà∑ÁöÑÂ∞èÊúãÂèãÂàóË°®
        loadChildrenList();
      } catch (error) {
        console.error('Ëß£ÊûêÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•', error);
      }
    }
    
    // Ê∑ªÂä†Á™óÂè£Â§ßÂ∞èÂèòÂåñÁõëÂê¨
    window.addEventListener('resize', handleResize);
    
    // Âä®ÊÄÅÂä†ËΩΩmarkdownËß£ÊûêÂ∫ì
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
    script.onload = () => {
      console.log('Markdown parser loaded');
    };
    script.onerror = (err) => {
      console.error('Failed to load markdown parser:', err);
    };
    document.head.appendChild(script);
  });

  onBeforeUnmount(() => {
    closeWebSocket();
    // ÂÅúÊ≠¢ËØ≠Èü≥ËØÜÂà´
    if (recognition.value) {
      recognition.value.stop();
    }
    // ÁßªÈô§Á™óÂè£Â§ßÂ∞èÂèòÂåñÁõëÂê¨
    window.removeEventListener('resize', handleResize);
  });

  // ÊñπÊ≥ï
  function initSpeechRecognition() {
    if ('webkitSpeechRecognition' in window) {
      recognition.value = new webkitSpeechRecognition();
      recognition.value.continuous = false;
      recognition.value.interimResults = false;
      recognition.value.lang = 'zh-CN';
      
      recognition.value.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        userInput.value = transcript;
        isListening.value = false;
        // Ëá™Âä®ÂèëÈÄÅËØÜÂà´Âà∞ÁöÑÂÜÖÂÆπ
        sendMessage();
      };
      
      recognition.value.onerror = (event) => {
        console.error('ËØ≠Èü≥ËØÜÂà´ÈîôËØØ:', event.error);
        isListening.value = false;
        ElMessage.error('ËØ≠Èü≥ËØÜÂà´Â§±Ë¥•ÔºåËØ∑ÈáçËØïÊàñ‰ΩøÁî®ÊñáÂ≠óËæìÂÖ•');
      };
      
      recognition.value.onend = () => {
        isListening.value = false;
      };
    } else {
      ElMessage.warning('‰Ω†ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´ÂäüËÉΩ');
    }
  }

  function toggleVoiceInput() {
    if (!recognition.value) {
      ElMessage.warning('‰Ω†ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ËØÜÂà´ÂäüËÉΩ');
      return;
    }
    
    if (isListening.value) {
      recognition.value.stop();
      isListening.value = false;
    } else {
      recognition.value.start();
      isListening.value = true;
      ElMessage.success('ÂºÄÂßãËÅÜÂê¨ÔºåËØ∑ÂØπÁùÄÈ∫¶ÂÖãÈ£éËØ¥ËØù...');
    }
  }

  function selectTheme(theme) {
    selectedTheme.value = theme;
  }

  function startStory() {
    if (!canStartStory.value) {
      ElMessage.warning('ËØ∑ÂÆåÂñÑÊïÖ‰∫ãËÆæÁΩÆ');
      return;
    }
    
    storyStarted.value = true;
    startTime.value = new Date().getTime();
    
    // Ê∑ªÂä†ÂàùÂßãAIÊ∂àÊÅØ
    messages.value = [{
      type: 'ai',
      content: 'ÊïÖ‰∫ãÁ≤æÁÅµÊ≠£Âú®ÂáÜÂ§á‰∏Ä‰∏™Á≤æÂΩ©ÁöÑÊïÖ‰∫ã...'
    }];
    
    // Âª∫Á´ãWebSocketËøûÊé•
    setupWebSocket();
    
    // Áü≠ÊöÇÂª∂ËøüÂêéÂèëÈÄÅÊïÖ‰∫ãÂºÄÂßãÊ∂àÊÅØ
    setTimeout(() => {
      sendStoryStartMessage();
    }, 1000);
  }

  function restartStory() {
    ElMessageBox.confirm('Á°ÆÂÆöË¶ÅÈáçÊñ∞ÂºÄÂßãÊïÖ‰∫ãÂêóÔºü', 'ÊèêÁ§∫', {
      confirmButtonText: 'Á°ÆÂÆö',
      cancelButtonText: 'ÂèñÊ∂à',
      type: 'warning'
    }).then(() => {
      // Â¶ÇÊûúÊïÖ‰∫ãÂ∑≤ÁªèÂºÄÂßãËøáÔºåÂàô‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï
      if (storyStarted.value && messages.value.length > 1) {
        saveStoryHistory();
      }
      
      storyStarted.value = false;
      messages.value = [];
      closeWebSocket();
    }).catch(() => {});
  }

  function sendStoryStartMessage() {
    // ÂàõÂª∫‰∏Ä‰∏™ÂàùÂßãÊïÖ‰∫ãÊèêÁ§∫
    const storyPrompt = `ÊàëÊÉ≥Âê¨‰∏Ä‰∏™ÂÖ≥‰∫é"${selectedTheme.value}"ÁöÑÊïÖ‰∫ã`;
    
    // ÂáÜÂ§áÂèëÈÄÅÂÜÖÂÆπ
    const message = {
      type: 'story',
      text: storyPrompt,
      username: childName.value,
      userId: userId.value,
      childId: childId.value,
      isNewStory: true,
      childAge: childAge.value,
      storyType: storyType.value,
      storyTheme: selectedTheme.value,
      startTime: new Date().getTime()
    };
    
    loading.value = true;
    
    // ÂèëÈÄÅÊ∂àÊÅØ
    if (socket.value.readyState === WebSocket.OPEN) {
      socket.value.send(JSON.stringify(message));
      console.log('ÊïÖ‰∫ãÂºÄÂßãËØ∑Ê±ÇÂ∑≤ÂèëÈÄÅ:', message);
    } else {
      ElMessage.error('ËøûÊé•Êú™Â∞±Áª™ÔºåËØ∑Á®çÂêéÂÜçËØï');
      loading.value = false;
      // Â∞ùËØïÈáçËøû
      handleReconnect();
    }
  }

  function setupWebSocket() {
    try {
      // ÂÖ≥Èó≠Â∑≤ÊúâËøûÊé•
      if (socket.value) {
        socket.value.close();
        socket.value = null;
      }

      // ÊûÑÂª∫WebSocket URL
      const wsUrl = `ws://localhost:8080/ws/story`;
      
      console.log('Ê≠£Âú®ËøûÊé•Âà∞ÊïÖ‰∫ãWebSocketÊúçÂä°Âô®:', wsUrl);
      socket.value = new WebSocket(wsUrl);
      
      // ËøûÊé•Ë∂ÖÊó∂Â§ÑÁêÜ
      const connectionTimeout = setTimeout(() => {
        if (!isConnected.value) {
          console.error('WebSocketËøûÊé•Ë∂ÖÊó∂');
          closeWebSocket();
          handleReconnect();
        }
      }, 5000);

      // ËøûÊé•ÊàêÂäü
      socket.value.onopen = (event) => {
        clearTimeout(connectionTimeout);
        console.log('ÊïÖ‰∫ãWebSocketËøûÊé•Â∑≤Âª∫Á´ã');
        isConnected.value = true;
        reconnectAttempts.value = 0;
        ElMessage.success('Â∑≤ËøûÊé•Âà∞ÊïÖ‰∫ãÁ≤æÁÅµ');
      };

      // Êé•Êî∂Ê∂àÊÅØ
      socket.value.onmessage = (event) => {
        try {
          let message = event.data;
          if (message.startsWith('data:')) {
            message = message.substring(5);
            // Ê£ÄÊü•ÁªìÊùüÊ†áËÆ∞
            if (message.includes('[DONE]')) {
              loading.value = false;
              console.log('ÊïÖ‰∫ãÂìçÂ∫îÂÆåÊàê');
              scrollToBottom(); // Á°Æ‰øùÊúÄÁªàÊªöÂä®Âà∞Â∫ïÈÉ®
              return;
            }
            
            // ËßÑËåÉÂåñÂ§ÑÁêÜÊ∂àÊÅØÊ†ºÂºè - ÁßªÈô§‰∏çÂøÖË¶ÅÁöÑÊç¢Ë°åÂíåÁ°Æ‰øùÈÄÇÂΩìÁöÑÁ©∫Ê†º
            message = message.trim();
            
            // Êõ¥Êñ∞ÊàñÂàõÂª∫AIÊ∂àÊÅØ
            if (messages.value.length > 0 && messages.value[messages.value.length - 1].type === 'ai') {
              // Ëé∑ÂèñÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØ
              const lastMessage = messages.value[messages.value.length - 1];
              
              // Ê∑ªÂä†‰∏Ä‰∏™Á©∫Ê†ºÔºåÂ¶ÇÊûú‰∏ä‰∏Ä‰∏™Â≠óÁ¨¶‰∏çÊòØÁ©∫Ê†ºÊàñÊç¢Ë°åÔºå‰∏îÂΩìÂâçÊ∂àÊÅØ‰∏ç‰ª•Ê†áÁÇπÁ¨¶Âè∑ÂºÄÂßã
              if (lastMessage.content.length > 0 && 
                  !/[\s\n]$/.test(lastMessage.content) && 
                  !/^[Ôºå„ÄÇÔºÅÔºü,.!?]/.test(message)) {
                message = ' ' + message;
              }
              
              // Êõ¥Êñ∞ÊúÄÂêé‰∏ÄÊù°AIÊ∂àÊÅØ
              lastMessage.content += message;
            } else {
              // ÂàõÂª∫Êñ∞ÁöÑAIÊ∂àÊÅØ
              messages.value.push({
                type: 'ai',
                content: message
              });
            }
            
            // ÂÆöÊúüÊªöÂä®Âà∞Â∫ïÈÉ®ÔºåÈÅøÂÖçÈ¢ëÁπÅÊªöÂä®
            if (scrollUpdateTimeout) {
              clearTimeout(scrollUpdateTimeout);
            }
            scrollUpdateTimeout = setTimeout(() => {
              scrollToBottom();
              scrollUpdateTimeout = null;
            }, 300);
          }
        } catch (error) {
          console.error('Â§ÑÁêÜWebSocketÊ∂àÊÅØÊó∂Âá∫Èîô:', error);
          ElMessage.error('Ê∂àÊÅØÂ§ÑÁêÜÂá∫Èîô');
        }
      };

      // ÈîôËØØÂ§ÑÁêÜ
      socket.value.onerror = (error) => {
        console.error('WebSocketÈîôËØØ:', error);
        isConnected.value = false;
        handleReconnect();
      };

      // ËøûÊé•ÂÖ≥Èó≠
      socket.value.onclose = (event) => {
        console.log('WebSocketËøûÊé•Â∑≤ÂÖ≥Èó≠', event);
        isConnected.value = false;
        if (!event.wasClean) {
          handleReconnect();
        }
      };
    } catch (error) {
      console.error('WebSocketÂàõÂª∫Â§±Ë¥•:', error);
      ElMessage.error(`ËøûÊé•Â§±Ë¥•: ${error.message}`);
      handleReconnect();
    }
  }

  function handleReconnect() {
    if (reconnectAttempts.value >= maxReconnectAttempts) {
      ElMessage.error('Êó†Ê≥ïËøûÊé•Âà∞ÊïÖ‰∫ãÊúçÂä°ÔºåËØ∑Á®çÂêéÂÜçËØï');
      isConnected.value = false;
      return;
    }

    reconnectAttempts.value++;
    const nextAttemptIn = reconnectInterval / 1000;
    ElMessage.warning(`ËøûÊé•Â§±Ë¥•Ôºå${nextAttemptIn}ÁßíÂêéÂ∞ùËØïÁ¨¨${reconnectAttempts.value}Ê¨°ÈáçËøû...`);

    setTimeout(() => {
      setupWebSocket();
    }, reconnectInterval);
  }

  function closeWebSocket() {
    if (socket.value) {
      socket.value.close();
      socket.value = null;
      isConnected.value = false;
    }
  }

  async function sendMessage() {
    if (!userInput.value.trim()) return;

    // Ê£ÄÊü•ËøûÊé•Áä∂ÊÄÅ
    if (!isConnected.value) {
      ElMessage.warning('Ê≠£Âú®ËøûÊé•Âà∞ÊïÖ‰∫ãÁ≤æÁÅµ...');
      setupWebSocket();
      return;
    }

    // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
    messages.value.push({
      type: 'user',
      content: userInput.value
    });
    
    // ÂáÜÂ§áÂèëÈÄÅÂÜÖÂÆπ
    const userMessage = userInput.value;
    userInput.value = '';

    loading.value = true;
    scrollToBottom();

    try {
      // ÊûÑÂª∫Ê∂àÊÅØÂØπË±°
      const message = {
        type: 'story',
        text: userMessage,
        username: childName.value,
        userId: userId.value,
        childId: childId.value,
        isNewStory: false,
        childAge: childAge.value,
        storyType: storyType.value
      };
      
      // ÂèëÈÄÅÊ∂àÊÅØ
      if (socket.value.readyState === WebSocket.OPEN) {
        socket.value.send(JSON.stringify(message));
        console.log('ÊïÖ‰∫ã‰∫§‰∫íÂ∑≤ÂèëÈÄÅ:', message);
      } else {
        throw new Error('WebSocketËøûÊé•Êú™Â∞±Áª™');
      }
    } catch (error) {
      console.error('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:', error);
      ElMessage.error('ÂèëÈÄÅÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
      loading.value = false;
      // Â∞ùËØïÈáçËøû
      handleReconnect();
    }
  }

  function formatContentWithPinyin(content) {
    // Â¶ÇÊûúÊ†áËÆ∞Â∫ìÂ∑≤Âä†ËΩΩÂíåÂÜÖÂÆπÂ≠òÂú®
    if (window.marked && content) {
      try {
        // Â§ÑÁêÜÊñáÊú¨Ê†ºÂºèÔºåËßÑËåÉÂåñÊç¢Ë°åÂíåÁ©∫Ê†º
        let formattedContent = content
          // ÊõøÊç¢ÊéâÂ§ö‰ΩôÁöÑÊç¢Ë°åÁ¨¶ÔºåËßÑËåÉÂåñÁ©∫ÁôΩÁ¨¶
          .replace(/\n\s*\n\s*\n/g, '\n\n')
          // Á°Æ‰øùÂú®Ê±âÂ≠ó‰πãÈó¥ÁöÑÊñ≠Ë°åÁÇπÊúâÈÄÇÂΩìÁöÑÁ©∫Ê†º
          .replace(/([^\s])\n([^\s])/g, '$1 $2');
        
        // Â§ÑÁêÜÊãºÈü≥Ê†áÊ≥®Ê†ºÂºèÔºåÂ∞ÜÂΩ¢Â¶Ç "Â≠óÔºàziÔºâ" ÁöÑÊ†ºÂºèËΩ¨Êç¢‰∏∫ ruby Ê†áÁ≠æ
        formattedContent = formattedContent.replace(/([‰∏Ä-Èæ•])Ôºà([a-zA-Z]+)Ôºâ/g, '<ruby>$1<rt>$2</rt></ruby>');
        
        // Ëß£ÊûêMarkdownÂÜÖÂÆπ
        let parsedContent = window.marked.parse(formattedContent);
        
        // ‰øÆÂ§çÂèØËÉΩÁöÑÊéíÁâàÈóÆÈ¢ò
        parsedContent = parsedContent
          // Ê∂àÈô§ÊÆµËêΩ‰πãÈó¥ÂèØËÉΩÁöÑ‰∏çÂøÖË¶ÅÈó¥Èöî
          .replace(/<\/p>\s*<p>/g, '</p><p>')
          // Á°Æ‰øùÊ±âÂ≠ó‰πãÈó¥ÁöÑÁ©∫Ê†º‰∏ç‰ºöÂØºËá¥‰∏çÂøÖË¶ÅÁöÑÊç¢Ë°å
          .replace(/([‰∏Ä-Èæ•])\s+([‰∏Ä-Èæ•])/g, '$1$2');
        
        return parsedContent;
      } catch (error) {
        console.error('Ëß£ÊûêMarkdownÊó∂Âá∫Èîô:', error);
        return content;
      }
    }
    // Â¶ÇÊûúÊ†áËÆ∞Â∫ìÊú™Âä†ËΩΩÔºåËøîÂõûÂéüÂßãÂÜÖÂÆπ
    return content;
  }

  function scrollToBottom() {
    nextTick(() => {
      const container = messageContainer.value;
      if (container) {
        // Use a slight delay to ensure content has rendered
        setTimeout(() => {
          container.scrollTop = container.scrollHeight;
        }, 50);
      }
    });
  }

  function handleAvatarError(event, type) {
    // Â§¥ÂÉèÂä†ËΩΩÂ§±Ë¥•Êó∂ÁöÑÂ§ÑÁêÜ
    if (type === 'user') {
      event.target.src = 'https://api.dicebear.com/7.x/adventurer/svg?seed=child';
    } else {
      event.target.src = 'https://api.dicebear.com/7.x/bottts/svg?seed=storybot';
    }
  }

  // Ê∑ªÂä†‰øùÂ≠òÊïÖ‰∫ãÂéÜÂè≤ËÆ∞ÂΩïÊñπÊ≥ï
  async function saveStoryHistory() {
    if (!userId.value) {
      console.warn('Áî®Êà∑Êú™ÁôªÂΩïÔºåÊó†Ê≥ï‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï');
      return;
    }
    
    try {
      // ËøáÊª§Âá∫Áî®Êà∑ÂíåAIÁöÑÂØπËØùÂÜÖÂÆπ
      const dialogMessages = messages.value.filter(msg => msg.type === 'user' || msg.type === 'ai');
      
      // ËÆ°ÁÆóÊïÖ‰∫ãÊåÅÁª≠Êó∂Èó¥ÔºàÁßíÔºâ
      const duration = Math.round((new Date().getTime() - startTime.value) / 1000);
      
      // ÂáÜÂ§áÂèëÈÄÅÂÜÖÂÆπ
      const historyData = {
        userId: userId.value,
        childId: childId.value,
        childName: childName.value,
        childAge: childAge.value,
        storyType: storyType.value,
        storyTheme: selectedTheme.value,
        duration: duration,
        messages: dialogMessages.map((msg, index) => ({
          content: msg.content,
          speaker: msg.type,
          sequence: index + 1
        }))
      };
      
      // ÂèëÈÄÅËØ∑Ê±Ç‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩï
      const { data } = await axios.post('/api/story/save-history', historyData);
      
      if (data.code === 200) {
        console.log('ÊïÖ‰∫ãÂéÜÂè≤ËÆ∞ÂΩï‰øùÂ≠òÊàêÂäü');
      } else {
        console.error('‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:', data.message);
      }
    } catch (error) {
      console.error('‰øùÂ≠òÂéÜÂè≤ËÆ∞ÂΩïÂºÇÂ∏∏:', error);
    }
  }

  function goToHistory() {
    // ‰øùÂ≠òÂΩìÂâçÊïÖ‰∫ãÂÜçË∑≥ËΩ¨
    if (storyStarted.value && messages.value.length > 1) {
      saveStoryHistory();
    }
    router.push('/history');
  }

  // ÂàáÊç¢‰æßËæπÊ†èÊòæÁ§∫Áä∂ÊÄÅ
  function toggleSidebar() {
    sidebarCollapsed.value = !sidebarCollapsed.value;
    localStorage.setItem('sidebarCollapsed', sidebarCollapsed.value);
  }

  // Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩïÂàóË°®
  async function loadHistoryList() {
    try {
      historyLoading.value = true;
      
      // ‰ªélocalStorageËé∑ÂèñÁî®Êà∑ID
      const userStr = localStorage.getItem('user');
      if (!userStr) {
        ElMessage.warning('ËØ∑ÂÖàÁôªÂΩï');
        historyLoading.value = false;
        return;
      }
      
      const user = JSON.parse(userStr);
      const { data } = await axios.get(`/api/story-record/user/${user.id}`);
      
      if (data.code === 200 && data.data) {
        historyList.value = data.data.sort((a, b) => {
          // ÊåâÂàõÂª∫Êó∂Èó¥ÂÄíÂ∫èÊéíÂàó
          return new Date(b.createTime) - new Date(a.createTime);
        });
      } else {
        historyList.value = [];
      }
    } catch (error) {
      console.error('Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:', error);
      ElMessage.error('Ëé∑ÂèñÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•');
      historyList.value = [];
    } finally {
      historyLoading.value = false;
    }
  }

  // Êü•ÁúãÂéÜÂè≤ËÆ∞ÂΩïËØ¶ÊÉÖ
  function viewHistoryDetail(recordId) {
    router.push(`/history/${recordId}`);
  }

  // Ê†ºÂºèÂåñÊó•Êúü
  function formatDate(dateStr) {
    if (!dateStr) return 'Êú™Áü•Êó∂Èó¥';
    const date = new Date(dateStr);
    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
  }

  // Ê†ºÂºèÂåñÊó∂Èïø
  function formatDuration(seconds) {
    if (!seconds || seconds <= 0) return '0ÂàÜÈíü';
    if (seconds < 60) return `${seconds}Áßí`;
    const minutes = Math.floor(seconds / 60);
    const remainSeconds = seconds % 60;
    return `${minutes}ÂàÜ${remainSeconds > 0 ? remainSeconds + 'Áßí' : ''}`;
  }

  // ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñ
  function handleResize() {
    isMobileView.value = window.innerWidth <= 768;
  }

  // Âä†ËΩΩËØ•Áî®Êà∑ÁöÑÂ∞èÊúãÂèãÂàóË°®
  async function loadChildrenList() {
    try {
      const userStr = localStorage.getItem('user');
      if (!userStr) {
        return;
      }
      
      const user = JSON.parse(userStr);
      const { data } = await axios.get(`/api/child/user/${user.id}`);
      
      if (data.code === 200) {
        childrenList.value = data.data || [];
        // Â¶ÇÊûúÊúâÂ∞èÊúãÂèãÔºåÈªòËÆ§ÈÄâÊã©Á¨¨‰∏Ä‰∏™
        if (childrenList.value.length > 0) {
          selectedChild.value = childrenList.value[0].id;
          childName.value = childrenList.value[0].name;
          childAge.value = childrenList.value[0].age;
          childGender.value = childrenList.value[0].gender || '';
          childId.value = childrenList.value[0].id;
        }
      }
    } catch (error) {
      console.error('Ëé∑ÂèñÂ∞èÊúãÂèãÂàóË°®Â§±Ë¥•:', error);
      ElMessage.error('Ëé∑ÂèñÂ∞èÊúãÂèãÂàóË°®Â§±Ë¥•');
    }
  }

  // Â§ÑÁêÜÂ∞èÊúãÂèãÈÄâÊã©
  function handleChildSelect(value) {
    if (value === 'create-new') {
      // ÈÄâÊã©ÂàõÂª∫Êñ∞Â∞èÊúãÂèã
      showCreateChild.value = true;
      childName.value = '';
      childAge.value = 5;
      childGender.value = '';
      childId.value = null;
    } else {
      // ÈÄâÊã©Â∑≤ÊúâÂ∞èÊúãÂèã
      showCreateChild.value = false;
      const selectedChildData = childrenList.value.find(child => child.id === value);
      if (selectedChildData) {
        childName.value = selectedChildData.name;
        childAge.value = selectedChildData.age;
        childGender.value = selectedChildData.gender || '';
        childId.value = selectedChildData.id;
      }
    }
  }

  // ÂàõÂª∫Êñ∞Â∞èÊúãÂèã
  async function createNewChild() {
    if (!childName.value.trim()) {
      ElMessage.warning('ËØ∑ËæìÂÖ•Â∞èÊúãÂèãÁöÑÂêçÂ≠ó');
      return;
    }
    
    try {
      creatingChild.value = true;
      const userStr = localStorage.getItem('user');
      if (!userStr) {
        ElMessage.warning('ËØ∑ÂÖàÁôªÂΩï');
        creatingChild.value = false;
        return;
      }
      
      const user = JSON.parse(userStr);
      const childData = {
        userId: user.id,
        name: childName.value.trim(),
        age: childAge.value,
        gender: childGender.value
      };
      
      const { data } = await axios.post('/api/child/add', childData);
      
      if (data.code === 200) {
        ElMessage.success('ÂàõÂª∫Â∞èÊúãÂèãÊàêÂäü');
        // Ê∑ªÂä†Âà∞ÂàóË°®
        childrenList.value.push(data.data);
        // ÈÄâÊã©Êñ∞ÂàõÂª∫ÁöÑÂ∞èÊúãÂèã
        selectedChild.value = data.data.id;
        childId.value = data.data.id;
        showCreateChild.value = false;
      } else {
        ElMessage.error(data.message || 'ÂàõÂª∫Â∞èÊúãÂèãÂ§±Ë¥•');
      }
    } catch (error) {
      console.error('ÂàõÂª∫Â∞èÊúãÂèãÂ§±Ë¥•:', error);
      ElMessage.error('ÂàõÂª∫Â∞èÊúãÂèãÂ§±Ë¥•');
    } finally {
      creatingChild.value = false;
    }
  }

  // ÂèñÊ∂àÂàõÂª∫Êñ∞Â∞èÊúãÂèã
  function cancelCreateChild() {
    showCreateChild.value = false;
    // Â¶ÇÊûúÊúâÂ∞èÊúãÂèãÔºåÈáçÊñ∞ÈÄâÊã©Á¨¨‰∏Ä‰∏™
    if (childrenList.value.length > 0) {
      selectedChild.value = childrenList.value[0].id;
      handleChildSelect(selectedChild.value);
    } else {
      selectedChild.value = null;
      childName.value = '';
      childId.value = null;
    }
  }
  </script>
  
  <style scoped>
  .background-view {
    min-height: 100vh;
    background-color: #f0f8ff;
    background-image: linear-gradient(135deg, #c9f0ff 0%, #f5f7fa 100%);
  }
  /* Ê∑±Ëâ≤Ê®°ÂºèÊ†∑Âºè */
.dark-mode {
  background-color: #121212;
  color: white;
}
  .storybook-view {
    display: flex;
    justify-content: flex-start;
    align-items: stretch;
    min-height: 100vh;
    padding: 20px;
    height: 100%;
  }
  
  /* ÂéÜÂè≤ËÆ∞ÂΩï‰æßËæπÊ†èÊ†∑Âºè */
  .history-sidebar {
    width: 280px;
    height: calc(100vh - 40px);
    background-color: white;
    border-radius: 16px 0 0 16px;
    box-shadow: 0 4px 20px rgba(0, 123, 255, 0.15);
    display: flex;
    flex-direction: column;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    z-index: 10;
    margin-right: 15px;
    position: relative;
  }
  
  .history-sidebar.collapsed {
    width: 50px;
    min-width: 50px;
    margin-right: 10px;
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.1);
  }
  
  .sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: linear-gradient(90deg, #5e72e4 0%, #825ee4 100%);
    color: white;
  }
  
  .sidebar-header h3 {
    margin: 0;
    font-size: 18px;
    white-space: nowrap;
    transition: opacity 0.2s;
  }
  
  .toggle-btn-container {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  .toggle-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 16px;
    z-index: 5;
    padding: 5px;
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 50%;
    height: 28px;
    width: 28px;
    transition: all 0.2s;
    background-color: rgba(255, 255, 255, 0.1);
  }
  
  .toggle-btn:hover {
    background-color: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
  }
  
  .toggle-btn:active {
    transform: scale(0.95);
  }
  
  .floating-toggle {
    position: absolute;
    right: -15px;
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 50px;
    background-color: white;
    border-radius: 0 8px 8px 0;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
    z-index: 5;
    opacity: 0;
    transition: opacity 0.3s;
  }
  
  .history-sidebar:hover .floating-toggle {
    opacity: 1;
  }
  
  .floating-toggle i {
    color: #5e72e4;
    font-size: 14px;
  }
  
  .history-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    scrollbar-width: thin;
    scrollbar-color: #d0d0d0 #f5f5f5;
  }
  
  .history-list::-webkit-scrollbar {
    width: 6px;
  }
  
  .history-list::-webkit-scrollbar-track {
    background: #f5f5f5;
  }
  
  .history-list::-webkit-scrollbar-thumb {
    background-color: #d0d0d0;
    border-radius: 6px;
  }
  
  .history-item {
    background-color: #f8f9fe;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
    border-left: 4px solid #5e72e4;
    position: relative;
    overflow: hidden;
  }
  
  .history-item:hover {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
    background-color: #f0f4ff;
  }
  
  .history-item:active {
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  .history-icon {
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 20px;
    color: #5e72e4;
    height: 24px;
  }
  
  .history-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
  }
  
  .history-title {
    font-weight: bold;
    font-size: 14px;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 150px;
  }
  
  .history-type {
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 10px;
    color: white;
  }
  
  .history-type.Â≠¶‰π†ÊàêÈïø {
    background-color: #2dce89;
  }
  
  .history-type.ÁîüÊ¥ªÊïôËÇ≤ {
    background-color: #fb6340;
  }
  
  .history-item-date {
    font-size: 12px;
    color: #777;
    margin-bottom: 4px;
  }
  
  .history-item-duration {
    font-size: 12px;
    color: #555;
  }
  
  .sidebar-footer {
    padding: 15px;
    display: flex;
    justify-content: center;
    border-top: 1px solid #eaeaea;
  }
  
  .refresh-icon {
    font-size: 20px;
    cursor: pointer;
    color: #5e72e4;
    transition: transform 0.5s ease;
  }
  
  .refresh-icon:hover {
    transform: rotate(180deg);
  }
  
  .sidebar-loading, .empty-history {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 200px;
    color: #888;
  }
  
  .loading-spinner {
    width: 30px;
    height: 30px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #5e72e4;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
  }
  
  .collapsed .history-item {
    padding: 8px 5px;
    text-align: center;
    border-left-width: 2px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .empty-history i {
    font-size: 32px;
    margin-bottom: 10px;
  }
  
  .empty-history p {
    margin: 0;
  }
  
  .mobile-sidebar-toggle {
    display: none;
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    margin-right: 10px;
  }
  
  .storybook-panel {
    flex: 1;
    background-color: white;
    border-radius: 16px;
    box-shadow: 0 6px 30px rgba(0, 123, 255, 0.15);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 40px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .storybook-panel.expanded {
    max-width: calc(100% - 60px);
  }
  
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 25px;
    background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
    color: white;
  }
  
  .header-left {
    display: flex;
    align-items: center;
  }
  
  .header h2 {
    margin: 0;
    font-size: 24px;
    font-weight: bold;
  }
  
  .expand-sidebar-btn {
    background: none;
    border: none;
    color: white;
    margin-right: 15px;
    cursor: pointer;
    font-size: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 5px;
    border-radius: 50%;
    transition: background-color 0.2s;
  }
  
  .expand-sidebar-btn:hover {
    background-color: rgba(255, 255, 255, 0.2);
  }
  
  @media (max-width: 768px) {
    .history-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      transform: translateX(0);
      z-index: 1000;
      border-radius: 0;
    }
    
    .history-sidebar.collapsed {
      transform: translateX(-100%);
      width: 280px; /* Âú®ÁßªÂä®Á´Ø‰øùÊåÅÂÆΩÂ∫¶‰∏çÂèòÔºå‰ΩÜÂÆåÂÖ®ÈöêËóè */
    }
    
    .mobile-sidebar-toggle {
      display: block;
    }

    .storybook-panel {
      width: 100% !important;
      border-radius: 10px;
    }
    
    .floating-toggle {
      display: none;
    }
  }
  
  .message-panel {
    display: flex;
    flex-direction: column;
    height: 100%;
    max-height: calc(100vh - 40px);
    overflow: hidden;
  }

  .header-actions {
    display: flex;
    align-items: center;
  }

  .status-indicator {
    font-size: 14px;
    padding: 4px 12px;
    border-radius: 20px;
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
  }

  .status-indicator.online {
    background-color: rgba(103, 194, 58, 0.8);
  }

  /* ÊïÖ‰∫ãËÆæÁΩÆÂå∫Âüü */
  .story-setup {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
    overflow-y: auto;
  }

  .story-setup-container {
    max-width: 600px;
    width: 100%;
    text-align: center;
  }

  .story-setup h3 {
    font-size: 28px;
    color: #6a11cb;
    margin-bottom: 30px;
  }

  .setup-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 30px;
  }

  .form-item {
    display: flex;
    flex-direction: column;
    text-align: left;
  }

  .form-item label {
    font-size: 16px;
    margin-bottom: 8px;
    color: #333;
  }

  .story-themes {
    margin-bottom: 30px;
  }

  .story-themes h4 {
    font-size: 18px;
    color: #333;
    margin-bottom: 15px;
  }

  .theme-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    justify-content: center;
  }

  .theme-card {
    background-color: #f5f7fa;
    border-radius: 12px;
    padding: 15px 10px;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  .theme-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }

  .theme-card.selected {
    background-color: #e0f0ff;
    border: 2px solid #2575fc;
  }

  .theme-icon {
    font-size: 28px;
    margin-bottom: 10px;
  }

  .theme-name {
    font-size: 14px;
    color: #333;
  }

  /* ÊïÖ‰∫ãÂÜÖÂÆπÂå∫Âüü */
  .story-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    max-height: calc(100vh - 200px);
    height: 100%;
    overflow: hidden;
  }

  .message-list {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background-color: #f9fafc;
    scroll-behavior: smooth;
    display: flex;
    flex-direction: column;
    max-height: calc(100vh - 300px);
  }

  .message-row {
    display: flex;
    align-items: flex-start;
    margin-bottom: 20px;
    width: 100%;
  }

  .message-row.user {
    justify-content: flex-end;
  }

  .message-row.ai {
    justify-content: flex-start;
  }

  .message-avatar {
    margin: 0 10px;
    flex-shrink: 0;
  }

  .avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    object-fit: cover;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  .message {
    max-width: 70%;
    padding: 15px 20px;
    border-radius: 16px;
    font-size: 15px;
    line-height: 1.6;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    word-wrap: break-word;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .user-message {
    background-color: #6a11cb;
    background-image: linear-gradient(to right, #6a11cb, #2575fc);
    color: white;
    border-bottom-right-radius: 4px;
  }

  .ai-message {
    background-color: white;
    color: #333;
    border: 1px solid #eaeaea;
    border-bottom-left-radius: 4px;
  }

  .message-input {
    padding: 15px 20px;
    border-top: 1px solid #eef2f7;
    background-color: white;
    flex-shrink: 0;
  }

  .message-input .el-textarea {
    margin-bottom: 10px;
  }

  .control-buttons {
    display: flex;
    justify-content: space-between;
  }

  /* Deep selectors for markdown content */
  :deep(.message .markdown) {
    white-space: pre-wrap;
  }

  :deep(.message h1), :deep(.message h2), :deep(.message h3) {
    margin: 10px 0;
    font-weight: bold;
  }

  :deep(.message h1) {
    font-size: 1.3em;
  }

  :deep(.message h2) {
    font-size: 1.2em;
  }

  :deep(.message h3) {
    font-size: 1.1em;
  }

  :deep(.message ul), :deep(.message ol) {
    padding-left: 20px;
    margin: 10px 0;
  }

  :deep(.message li) {
    margin: 5px 0;
  }

  :deep(.message p) {
    margin: 8px 0;
  }

  :deep(.message code) {
    background-color: rgba(0, 0, 0, 0.05);
    padding: 2px 4px;
    border-radius: 3px;
  }

  :deep(.message pre) {
    background-color: rgba(0, 0, 0, 0.05);
    padding: 10px;
    border-radius: 5px;
    overflow-x: auto;
  }

  :deep(.message blockquote) {
    border-left: 3px solid #ddd;
    padding-left: 10px;
    color: #666;
    margin: 10px 0;
  }

  :deep(.message strong) {
    font-weight: bold;
  }

  :deep(.message em) {
    font-style: italic;
  }
  </style>
  
  <style>
  /* Markdown Ê†∑Âºè */
  .ai-message h1, .ai-message h2, .ai-message h3 {
    margin: 10px 0;
    font-weight: bold;
    word-break: break-word;
  }
  
  .ai-message h1 {
    font-size: 1.3em;
  }
  
  .ai-message h2 {
    font-size: 1.2em;
  }
  
  .ai-message h3 {
    font-size: 1.1em;
  }
  
  .ai-message ul, .ai-message ol {
    padding-left: 20px;
    margin: 10px 0;
  }
  
  .ai-message li {
    margin: 5px 0;
  }
  
  .ai-message p {
    margin: 8px 0;
    word-break: break-word;
    white-space: pre-wrap;
    display: block;
  }
  
  .ai-message code {
    background-color: rgba(0, 0, 0, 0.05);
    padding: 2px 4px;
    border-radius: 3px;
    word-break: break-word;
  }
  
  .ai-message pre {
    background-color: rgba(0, 0, 0, 0.05);
    padding: 10px;
    border-radius: 5px;
    overflow-x: auto;
    white-space: pre-wrap;
    word-break: break-word;
  }
  
  .ai-message blockquote {
    border-left: 3px solid #ddd;
    padding-left: 10px;
    color: #666;
    margin: 10px 0;
  }
  
  .ai-message strong {
    font-weight: bold;
  }
  
  .ai-message em {
    font-style: italic;
  }
  </style>
  
  <style>
  /* ‰øÆÂ§ç‰∏≠ÊñáÊòæÁ§∫ */
  .message div {
    word-break: normal;
    word-wrap: break-word;
    overflow-wrap: break-word;
    text-align: left;
  }

  /* ÊîπËøõÊãºÈü≥ÊòæÁ§∫ */
  ruby {
    display: inline-flex;
    flex-direction: column;
    text-align: center;
    line-height: 1.5;
  }

  rt {
    font-size: 0.6em;
    line-height: 1.2;
    text-align: center;
    color: #666;
  }
  </style>
  
  <style>
  .child-name-selector {
    position: relative;
    width: 100%;
  }

  .create-child-form {
    margin-top: 15px;
    padding: 15px;
    background-color: #f8f9fe;
    border-radius: 8px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .child-form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 5px;
  }
  </style>
  
  
